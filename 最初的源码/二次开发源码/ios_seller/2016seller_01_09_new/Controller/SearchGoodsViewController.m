//
//  SearchGoodsViewController.m
//  SellerApp
//
//  Created by barney on 16/1/8.
//  Copyright ¬© 2016Âπ¥ apple. All rights reserved.
//

#import "SearchGoodsViewController.h"
#import "goodsModel.h"
#import "goodsListCell.h"
#import "GoodsPreviewViewController.h"
#import "goodseditViewController.h"
@interface SearchGoodsViewController ()

@end

@implementation SearchGoodsViewController
{
    UITableView *goodsTableView;
    NSMutableArray *dataArray;
    UITextField *MyTextField;
    int count;

}
-(void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:YES];
    [[self navigationController] setNavigationBarHidden:YES animated:NO];
     self.tabBarController.tabBar.hidden=YES;
}
-(void)viewWillDisappear:(BOOL)animated{
    [super viewWillDisappear:YES];
    [[self navigationController] setNavigationBarHidden:NO animated:NO];
    self.tabBarController.tabBar.hidden=NO;
}
- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    self.view.backgroundColor = UIColorFromRGB(0xf5f5f5);
   dataArray = [[NSMutableArray alloc]init];
    count=1;
    if (UIDeviceSystem>=7.0) {
        self.automaticallyAdjustsScrollViewInsets = NO;
    }else{
    }
    
    goodsTableView = [[UITableView alloc] initWithFrame:CGRectMake(0, ScreenFrame.origin.y+64, ScreenFrame.size.width, ScreenFrame.size.height-64)];
    //Á©∫Áä∂ÊÄÅËßÜÂõæ
    [MyObject noDataViewIn:self.view];
    //ÊêúÁ¥¢ÂàóË°®ËÆæÁΩÆ
     goodsTableView.separatorStyle = UITableViewCellSeparatorStyleNone;
     goodsTableView.delegate = self;
     goodsTableView.dataSource=  self;
     goodsTableView.hidden=YES;
     goodsTableView.showsVerticalScrollIndicator=NO;
     goodsTableView.showsHorizontalScrollIndicator = NO;
     goodsTableView.backgroundColor=UIColorFromRGB(0xf5f5f5);
    goodsTableView.mj_header = [MJRefreshNormalHeader headerWithRefreshingTarget:self refreshingAction:@selector(headerRereshing)];
    goodsTableView.mj_footer = [MJRefreshAutoNormalFooter footerWithRefreshingTarget:self refreshingAction:@selector(footerRereshing)];
    [self.view addSubview: goodsTableView];
    
    [self createTopView];

}
#pragma mark -‰∏äÊãâÂà∑Êñ∞„ÄÅ‰∏ãÊãâÂä†ËΩΩ
-(void)headerRereshing{
    [self netJson];
    [goodsTableView.mj_header endRefreshing];
}
-(void)footerRereshing{
    count ++;
    [self netJson];
    [goodsTableView.mj_footer endRefreshing];
}
//ÂàõÂª∫È°∂ÈÉ®ÊêúÁ¥¢Êéß‰ª∂
-(void)createTopView{
    UIView *view = [[UIView alloc]initWithFrame:CGRectMake(0, 0, ScreenFrame.size.width, 64)];
    view.backgroundColor = NAV_COLOR;
    [self.view addSubview:view];
    UIButton *button = [UIButton buttonWithType:UIButtonTypeCustom ];
    button.frame =CGRectMake(13, 20, 44, 44);
    [button setBackgroundImage:[UIImage imageNamed:@"back_lj"] forState:UIControlStateNormal];
    [button addTarget:self action:@selector(backBtnClicked) forControlEvents:UIControlEventTouchUpInside];
    [view addSubview:button];
    
    MyTextField = [LJControl textFieldFrame:CGRectMake(55, 27, ScreenFrame.size.width-100, 30) text:@"" placeText:@" üîçÊêúÁ¥¢ÂïÜÂìÅ" setfont:17 textColor:[UIColor blackColor] keyboard:UIKeyboardTypeDefault];
    MyTextField.delegate = self;
    MyTextField.backgroundColor = [UIColor whiteColor];
    [MyTextField.layer setMasksToBounds:YES];
    [MyTextField.layer setCornerRadius:4.0];
    [view addSubview:MyTextField];
    
    UIToolbar * topView = [[UIToolbar alloc]initWithFrame:CGRectMake(0, 0, ScreenFrame.size.width, 30)];
    [topView setBarStyle:UIBarStyleBlack];
    UIBarButtonItem * helloButton = [[UIBarButtonItem alloc]initWithTitle:@"" style:UIBarButtonItemStyleDone target:self action:nil];
    UIBarButtonItem * btnSpace = [[UIBarButtonItem alloc]initWithBarButtonSystemItem:UIBarButtonSystemItemFlexibleSpace target:self action:nil];
    UIBarButtonItem *doneButton = [[UIBarButtonItem alloc]initWithTitle:@"ÂÆåÊàê" style:UIBarButtonItemStyleDone target:self action:@selector(dismissKeyBoard)];
    NSArray * buttonsArray = [NSArray arrayWithObjects:helloButton,btnSpace,doneButton,nil];
    [topView setItems:buttonsArray];
    [MyTextField setInputAccessoryView:topView];
    
    UIButton *leftbtn = [LJControl buttonType:UIButtonTypeCustom setFrame:CGRectMake(ScreenFrame.size.width-40, 27, 34, 30) setNormalImage:[UIImage imageNamed:@""] setSelectedImage:[UIImage imageNamed:@""] setTitle:@"ÊêúÁ¥¢" setTitleFont:13 setbackgroundColor:[UIColor clearColor]];
    leftbtn.titleLabel.font = [UIFont boldSystemFontOfSize:12];
    leftbtn.layer.borderWidth = 1.5;
    leftbtn.layer.borderColor = [[UIColor whiteColor] CGColor];
    [leftbtn.layer setMasksToBounds:YES];
    [leftbtn.layer setCornerRadius:2.0];
    [leftbtn addTarget:self action:@selector(searchBtnClicked) forControlEvents:UIControlEventTouchUpInside];
    [view addSubview:leftbtn];
}
//ÊêúÁ¥¢ÊåâÈíÆÂìçÂ∫î‰∫ã‰ª∂
-(void)searchBtnClicked{
    [MyTextField resignFirstResponder];
    if (MyTextField.text.length==0) {
        
        [OHAlertView showAlertWithTitle:@"ÊèêÁ§∫" message:@"ËØ∑ËæìÂÖ•ÊêúÁ¥¢ÂÜÖÂÆπ" cancelButton:nil otherButtons:@[@"Á°ÆÂÆö"] buttonHandler:^(OHAlertView *alert, NSInteger buttonIndex) {
            
        }];
        
    }else
    {
    [MyObject startLoading];
    [self netJson];//ÂèëËµ∑ÁΩëÁªúËØ∑Ê±Ç
    }
}

-(void)backBtnClicked{
    [self.navigationController popViewControllerAnimated:YES];
}
-(void)dismissKeyBoard{
    [MyTextField resignFirstResponder];
}
#pragma mark - uitextfield
-(BOOL)textFieldShouldReturn:(UITextField *)textField{
    [MyTextField resignFirstResponder];
    return YES;
}

#pragma mark - ÁΩëÁªúËß£Êûê
-(void)netJson
{
    [MyObject startLoading];
    NSString *urlStr = [NSString stringWithFormat:@"%@%@",SELLER_URL,GOODS_LIST_URL];
    NSDictionary *par = @{
                          @"user_id":[MyNetTool currentUserID],
                          @"token":[MyNetTool currentToken],
                          @"goods_status":@"",
                          @"orderby":@"",
                          @"ordertype":@"asc",
                          @"begin_count":@"0",
                          @"select_count":[NSString stringWithFormat:@"%d",count*10],
                          @"user_goodsclass_id":@"",
                          @"goods_name":MyTextField.text
                          
                          };
    [[MyNetTool managerWithVerify]POST:urlStr parameters:par success:^(AFHTTPRequestOperation *operation, id responseObject) {
        [MyObject endLoading];
        NSDictionary * dicBig=responseObject;
        NSLog(@"/////////ÂïÜÂìÅÊêúÁ¥¢ÂàóË°®%@",dicBig);
        
        if (dicBig)
        {
            dataArray=[[NSMutableArray alloc]init];
            for (NSDictionary *dictt in [dicBig objectForKey:@"goods_list"])
            {
                goodsModel *model=[[goodsModel alloc]init];
                //kvc Ê®°ÂûãËµãÂÄº
                [model setValuesForKeysWithDictionary:dictt];
                [dataArray addObject:model];
                
            }
            [goodsTableView reloadData];
            //Á©∫Áä∂ÊÄÅ
            if (dataArray.count == 0) {
                goodsTableView.hidden = YES;
            }else
            {
                goodsTableView.hidden = NO;
            }
            
        }
        
    } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
        NSLog(@"%@",[error localizedDescription]);
        goodsTableView.hidden=YES;
        [MyObject endLoading];
        
        
    }];
 
}
#pragma mark - UITableView
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    if (dataArray.count != 0)
    {
        return dataArray.count;
    }
     return 0;
}
-(CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    return 190;
}
-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    static NSString *myTabelviewCell = @"goodsListCell";
    goodsListCell *cell = [tableView dequeueReusableCellWithIdentifier:myTabelviewCell];
    if(cell == nil){
        cell = [[[NSBundle mainBundle] loadNibNamed:@"goodsListCell" owner:self options:nil] lastObject];
        
    }
    goodsModel *model=[dataArray objectAtIndex:indexPath.row];
    cell.selectionStyle=UITableViewCellSelectionStyleNone;
    cell.title.text=model.goods_name;
    [cell.img sd_setImageWithURL:[NSURL URLWithString:model.goods_main_photo]placeholderImage:[UIImage imageNamed:@"loading"]];
    cell.price.text=[NSString stringWithFormat:@"Ôø•%@",model.goods_current_price];
    cell.didSale.text=[NSString stringWithFormat:@"Â∑≤ÂîÆ %@",model.goods_salenum];
    cell.kc.text=[NSString stringWithFormat:@"Â∫ìÂ≠ò %@",model.goods_inventory];
  
    NSLog(@"model.goods_status=%@",model.goods_status);
    if ([model.goods_status integerValue]==1||[model.goods_status integerValue]==2||[model.goods_status integerValue]==-1||[model.goods_status integerValue]==-2||[model.goods_status integerValue]==-5||[model.goods_status integerValue]==-6) {
        cell.saleOffLabel.text=@"‰∏äÊû∂";
    }else{
        cell.saleOffLabel.text=@"‰∏ãÊû∂";
    }
    cell.edit.tag=10000+indexPath.row;
    [cell.edit addTarget:self action:@selector(cellButtonClick:) forControlEvents:UIControlEventTouchUpInside];
    cell.saleOff.tag=20000+indexPath.row;
    [cell.saleOff addTarget:self action:@selector(cellButtonClick:) forControlEvents:UIControlEventTouchUpInside];
    cell.share.tag=30000+indexPath.row;
    [cell.share addTarget:self action:@selector(cellButtonClick:) forControlEvents:UIControlEventTouchUpInside];
    cell.del.tag=40000+indexPath.row;
    [ cell.del addTarget:self action:@selector(cellButtonClick:) forControlEvents:UIControlEventTouchUpInside];
    
    return cell;
}
//cellÈáå4‰∏™ÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂
-(void)cellButtonClick:(UIButton *)btn{
    NSLog(@"btn.tag=%ld",(long)btn.tag);
    NSInteger theFew=btn.tag/10000;
    goodsModel *model=[dataArray objectAtIndex:btn.tag%10000];
    if (theFew==1) {
        //ÁºñËæë
        goodseditViewController *gvc=[[goodseditViewController alloc]init];
        gvc.model=model;
        [self.navigationController pushViewController:gvc animated:YES];
    }else if (theFew==2) {
        //‰∏ãÊû∂
//        NSIndexPath *index = [NSIndexPath indexPathForItem:btn.tag%10000 inSection:0];
//        goodsListCell *cell = [goodsTableView cellForRowAtIndexPath:index];
        NSInteger s=[model.goods_status integerValue];
        if (s==0) {
            //0‰∏∫‰∏äÊû∂
            [OHAlertView showAlertWithTitle:@"Á°ÆÂÆö‰∏ãÊû∂Ê≠§ÂïÜÂìÅÔºü" message:@"" cancelButton:nil otherButtons:@[@"ÂèñÊ∂à",@"Á°ÆÂÆö"] buttonHandler:^(OHAlertView *alert, NSInteger buttonIndex) {
                if(buttonIndex==0){
                }else{
                    [self getGoodsSaleMulitId:model];
                }
            }];
            
        }else if (s==1){
            //1‰∏∫Âú®‰ªìÂ∫ì‰∏≠
            [OHAlertView showAlertWithTitle:@"Á°ÆÂÆö‰∏äÊû∂Ê≠§ÂïÜÂìÅÔºü" message:@"" cancelButton:nil otherButtons:@[@"ÂèñÊ∂à",@"Á°ÆÂÆö"] buttonHandler:^(OHAlertView *alert, NSInteger buttonIndex) {
                if(buttonIndex==0){
                }else{
                    [self getGoodsSaleMulitId:model];
                }
            }];
        }else if (s==2){
            //2‰∏∫ÂÆöÊó∂Ëá™Âä®‰∏äÊû∂
            [OHAlertView showAlertWithTitle:@"ËØ•ÂïÜÂìÅÂ∑≤ÁªèÂÆöÊó∂Ëá™Âä®‰∏äÊû∂" message:@"ÊòØÂê¶ÊèêÂâçÊâãÂä®‰∏äÊû∂Ôºü" cancelButton:nil otherButtons:@[@"ÂèñÊ∂à",@"Á°ÆÂÆö"] buttonHandler:^(OHAlertView *alert, NSInteger buttonIndex) {
                if(buttonIndex==0){
                }else{
                    [self getGoodsSaleMulitId:model];
                }
            }];
        }else if (s==3){
            //3‰∏∫Â∫óÈì∫ËøáÊúüËá™Âä®‰∏ãÊû∂
            [OHAlertView showAlertWithTitle:@"ËØ•ÂïÜÂìÅÂ∫óÈì∫ËøáÊúü‰ºöËá™Âä®‰∏ãÊû∂" message:@"ÊòØÂê¶ÊèêÂâçÊâãÂä®‰∏ãÊû∂Ôºü" cancelButton:nil otherButtons:@[@"ÂèñÊ∂à",@"Á°ÆÂÆö"] buttonHandler:^(OHAlertView *alert, NSInteger buttonIndex) {
                if(buttonIndex==0){
                }else{
                    [self getGoodsSaleMulitId:model];
                }
            }];
        }else if (s==-1){
            //-1‰∏∫ÊâãÂä®‰∏ãÊû∂Áä∂ÊÄÅ
            [OHAlertView showAlertWithTitle:@"Á°ÆÂÆö‰∏äÊû∂Ê≠§ÂïÜÂìÅÔºü" message:@"" cancelButton:nil otherButtons:@[@"ÂèñÊ∂à",@"Á°ÆÂÆö"] buttonHandler:^(OHAlertView *alert, NSInteger buttonIndex) {
                if(buttonIndex==0){
                }else{
                    [self getGoodsSaleMulitId:model];
                }
            }];
            
        }else if (s==-2){
            //-2‰∏∫ËøùËßÑ‰∏ãÊû∂Áä∂ÊÄÅ
            [OHAlertView showAlertWithTitle:@"ÊèêÁ§∫" message:@"ËØ•ÂïÜÂìÅËøùËßÑ‰∏ãÊû∂" cancelButton:nil otherButtons:@[@"Á°ÆÂÆö"] buttonHandler:^(OHAlertView *alert, NSInteger buttonIndex) {
            }];
            
        }else if (s==-5){
            //-5‰∏∫Âπ≥Âè∞Êú™ÂÆ°Ê†∏
            [OHAlertView showAlertWithTitle:@"ËØ•ÂïÜÂìÅ‰∏äÊû∂Áî≥ËØ∑Â∑≤ÁªèÊèê‰∫§ÂêéÂè∞ÂÆ°Ê†∏„ÄÇ" message:@"ËØ∑Á≠âÂæÖ„ÄÇ" cancelButton:nil otherButtons:@[@"Á°ÆÂÆö"] buttonHandler:^(OHAlertView *alert, NSInteger buttonIndex) {
            }];
        }else if (s==-6){
            //-6Âπ≥Âè∞ÂÆ°Ê†∏ÊãíÁªù
            [OHAlertView showAlertWithTitle:@"ÊèêÁ§∫" message:@"ËØ•ÂïÜÂìÅ‰∏äÊû∂Áî≥ËØ∑Ë¢´ÂêéÂè∞ÊãíÁªù„ÄÇ" cancelButton:nil otherButtons:@[@"Á°ÆÂÆö"] buttonHandler:^(OHAlertView *alert, NSInteger buttonIndex) {
            }];
        }
    }else if (theFew==3) {
        //ÂàÜ‰∫´
    }else if (theFew==4) {
        //Âà†Èô§
        [OHAlertView showAlertWithTitle:@"Á°ÆÂÆöÂà†Èô§Ê≠§ÂïÜÂìÅÔºü" message:@"" cancelButton:nil otherButtons:@[@"ÂèñÊ∂à",@"Á°ÆÂÆö"] buttonHandler:^(OHAlertView *alert, NSInteger buttonIndex) {
            if(buttonIndex==0){
            }else{
                [self getGoodsDeleteMulitId:model.goods_id];
            }
        }];
    }
}
#pragma mark -‰∏ãÊû∂ËØ∑Ê±Ç
-(void)getGoodsSaleMulitId:(goodsModel *)model{
    [MyObject startLoading];
    NSString *urlStr = [NSString stringWithFormat:@"%@%@",SELLER_URL,STORE_GOODS_DOWN_SHELVES_URL];
    NSDictionary *par = @{
                          @"user_id":[MyNetTool currentUserID],
                          @"token":[MyNetTool currentToken],
                          @"mulitId":model.goods_id
                          };
    [myAfnetwork netWorkingURL:urlStr parameters:par andWay:@"post" getParseSuccess:^(myselfParse *parse) {
        NSDictionary *dicBig=parse.dicBig;
        NSLog(@"%@",dicBig);
        NSString *str=[dicBig objectForKey:@"success"];
        if (str) {
            NSInteger s=[model.goods_status intValue];
            if (s==1||s==2||s==-1) {
                [MyObject failedPrompt:@"‰∏äÊû∂ÊàêÂäü"];
                [self netJson];
            }else{
                [MyObject failedPrompt:@"‰∏ãÊû∂ÊàêÂäü"];
                [self netJson];
            }
        }
        [MyObject endLoading];
    }getParsefailure:^{
        [MyObject failedPrompt:@"ÁΩëÁªúËøôÂú®ÂºÄÂ∞èÂ∑Æ"];
        [MyObject endLoading];
    }];
}
#pragma mark -Âà†Èô§ËØ∑Ê±Ç
-(void)getGoodsDeleteMulitId:(NSString *)mulitId{
    [MyObject startLoading];
    NSString *urlStr = [NSString stringWithFormat:@"%@%@",SELLER_URL,STORE_GOODS_DELETE_URL];
    NSDictionary *par = @{
                          @"user_id":[MyNetTool currentUserID],
                          @"token":[MyNetTool currentToken],
                          @"mulitId":mulitId
                          };
    [myAfnetwork netWorkingURL:urlStr parameters:par andWay:@"post" getParseSuccess:^(myselfParse *parse) {
        NSDictionary *dicBig=parse.dicBig;
        NSLog(@"%@",dicBig);
        NSString *str=[dicBig objectForKey:@"success"];
        if (str) {
            [MyObject failedPrompt:@"Âà†Èô§ÊàêÂäü"];
            [self headerRereshing];
        }
        [MyObject endLoading];
    }getParsefailure:^{
        [MyObject failedPrompt:@"ÁΩëÁªúËøôÂú®ÂºÄÂ∞èÂ∑Æ"];
        [MyObject endLoading];
    }];
}
//tableViewÈáåcellÁöÑÁÇπÂáª‰∫ã‰ª∂
-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    
       goodsModel *model=[dataArray objectAtIndex:indexPath.row];
        NSLog(@"%@",model);
        GoodsPreviewViewController *gpvc=[[GoodsPreviewViewController alloc]init];
        gpvc.model=model;
        [self.navigationController pushViewController:gpvc animated:YES];
        
   
}
- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
